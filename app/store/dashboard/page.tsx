"use client"

import { useState, useEffect } from "react"
import { useRouter } from "next/navigation"
import { useStoreAuth } from "@/components/store-auth-provider"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Switch } from "@/components/ui/switch"
import { Label } from "@/components/ui/label"
import { Clock, CheckCircle, AlertCircle, RefreshCcw, Search, Package, ClipboardList } from "lucide-react"
import { OrderCard } from "@/components/order-card"
import { syncOrderStatus } from "@/lib/sync-service"
import { Badge } from "@/components/ui/badge"
import { getFoodItemsByStoreId } from "@/lib/food-item-service"

export default function StoreDashboardPage() {
  const { account, loading } = useStoreAuth()
  const router = useRouter()
  const [orders, setOrders] = useState([])
  const [searchQuery, setSearchQuery] = useState("")
  const [isOpen, setIsOpen] = useState(true)
  const [activeTab, setActiveTab] = useState("all")
  const [products, setProducts] = useState([])
  const [isRefreshing, setIsRefreshing] = useState(false)
  const [storeInfo, setStoreInfo] = useState<any>(null)

  // Ê™¢Êü•ÊòØÂê¶Â∑≤ÁôªÂÖ•ÔºàÂª∂ËøüÊ£ÄÊü•ÈÅøÂÖçÊó∂Â∫èÈóÆÈ¢òÔºâ
  useEffect(() => {
    // ‚úÖ Ê∑ªÂä†Âª∂ËøüÁ°Æ‰øù Provider ÂÆåÂÖ®ÂàùÂßãÂåñ
    const checkAuthTimer = setTimeout(() => {
      if (!loading && !account) {
        console.log("‚ùå Dashboard: Ê£ÄÊü•ÂêéÁ°ÆËÆ§Êú™ÁôªÂÖ•ÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢")
        router.push("/login?tab=store")
      } else if (account) {
        console.log("‚úÖ Dashboard: Â∑≤ÁôªÂÖ•Â∫óÂÆ∂:", account.name || account.username, "storeId:", account.storeId)
      } else if (loading) {
        console.log("‚è≥ Dashboard: ‰ªçÂú®Âä†ËΩΩ‰∏≠ÔºåÁ≠âÂæÖ...")
      }
    }, 300) // Âª∂Ëøü 300ms Ê£ÄÊü•

    return () => clearTimeout(checkAuthTimer)
  }, [account, loading, router])

  // ‚úÖ Áõ¥Êé•‰ΩøÁî® account Ë≥áË®äÔºà‰æÜËá™Ë≥áÊñôÂ∫´Ôºâ
  useEffect(() => {
    if (account) {
      console.log("‚úÖ Dashboard: ‰ΩøÁî®Ë≥áÊñôÂ∫´Â∫óÂÆ∂Ë≥áË®ä:", account)
      setStoreInfo(account)
    }
  }, [account])

  // ËºâÂÖ•Ë®ÇÂñÆÂíåÂïÜÂìÅÊï∏Êìö
  useEffect(() => {
    if (!account) return

    const loadStoreData = async () => {
      try {
        // ‚úÖ ‰ªéÊï∞ÊçÆÂ∫ì API Ëé∑ÂèñËÆ¢Âçï
        console.log("üì• Ëé∑ÂèñËÆ¢ÂçïÔºåstoreId:", account.storeId)
        const res = await fetch(`/api/orders?storeId=${account.storeId}`, {
          cache: "no-store"
        })
        
        if (res.ok) {
          const json = await res.json()
          if (json.success && json.orders) {
            const storeOrders = json.orders.map((o: any) => ({
              id: o.id,
              userId: o.user_id || o.userId,
              storeId: o.store_id || o.storeId,
              storeName: o.store_name || o.storeName,
              status: o.status,
              createdAt: o.created_at || o.createdAt,
              updatedAt: o.updated_at || o.updatedAt,
              acceptedAt: o.accepted_at || o.acceptedAt,
              preparedAt: o.prepared_at || o.preparedAt,
              completedAt: o.completed_at || o.completedAt,
              total: Number(o.total || 0),
              items: (o.order_items || o.items || []).map((item: any) => ({
                id: item.product_id || item.id,
                name: item.product_name || item.name,
                price: Number(item.price),
                quantity: Number(item.quantity),
              })),
              customerInfo: o.customer_info || o.customerInfo,
              customer: o.customer_info || o.customerInfo,
              note: o.note,
              reason: o.reason,
              cancelledBy: o.cancelled_by,
            }))
            setOrders(storeOrders)
          } else {
            setOrders([])
          }
        } else {
          setOrders([])
        }

        // ‚úÖ ‰ªéÊï∞ÊçÆÂ∫ì API Ëé∑ÂèñÂïÜÂìÅÊï∞ÊçÆ
        const productsRes = await fetch(`/api/user/products?storeId=${account.storeId}`)
        if (productsRes.ok) {
          const productsJson = await productsRes.json()
          setProducts(productsJson.products || [])
        } else {
          setProducts([])
        }
      } catch (error) {
        console.error("Error loading data:", error)
        setOrders([])
        setProducts([])
      }
    }

    loadStoreData()

    // ‚úÖ Áõ£ËÅΩË®ÇÂñÆÁãÄÊÖãËÆäÂåñ - ÈáçÊñ∞Âä†ËΩΩ
    const handleOrderStatusUpdate = () => {
      loadStoreData()
    }

    // ‚úÖ Áõ£ËÅΩÊñ∞Ë®ÇÂñÆ - ÈáçÊñ∞Âä†ËΩΩ
    const handleNewOrder = () => {
      loadStoreData()
    }

    // Áõ£ËÅΩÂïÜÂìÅÊï∏ÊìöËÆäÂåñ
    const handleProductsUpdate = () => {
      try {
        const storeProducts = getFoodItemsByStoreId(account.storeId)
        setProducts(storeProducts || [])
      } catch (error) {
        console.error("Error updating products:", error)
      }
    }

    window.addEventListener("orderStatusUpdated", handleOrderStatusUpdate)
    window.addEventListener("newOrder", handleNewOrder)
    window.addEventListener("foodItemsUpdated", handleProductsUpdate)
    window.addEventListener("foodItemDeleted", handleProductsUpdate)

    return () => {
      window.removeEventListener("orderStatusUpdated", handleOrderStatusUpdate)
      window.removeEventListener("newOrder", handleNewOrder)
      window.removeEventListener("foodItemsUpdated", handleProductsUpdate)
      window.removeEventListener("foodItemDeleted", handleProductsUpdate)
    }
  }, [account])

  // Ê†πÊìöÁãÄÊÖãÂàÜÈ°ûË®ÇÂñÆ
  const ordersByStatus = {
    pending: orders.filter((order) => order.status === "pending"),
    accepted: orders.filter((order) => order.status === "accepted"),
    prepared: orders.filter((order) => order.status === "prepared"),
    completed: orders.filter((order) => order.status === "completed"),
    cancelled: orders.filter((order) => order.status === "cancelled" || order.status === "rejected"),
  }

  // Ê†πÊìöÊêúÂ∞ãË©ûÈÅéÊøæË®ÇÂñÆ
  const filteredOrders = orders.filter((order) => {
    // ÂÖàÊ†πÊìöÊ®ôÁ±§ÈÅéÊøæ
    if (activeTab !== "all" && order.status !== activeTab) {
      return false
    }

    // ÂÜçÊ†πÊìöÊêúÂ∞ãË©ûÈÅéÊøæ
    if (searchQuery) {
      const query = searchQuery.toLowerCase()
      return (
        order.id.toLowerCase().includes(query) ||
        (order.customer?.name && order.customer.name.toLowerCase().includes(query)) ||
        (order.customer?.phone && order.customer.phone.includes(query)) ||
        order.items.some((item) => item.name.toLowerCase().includes(query))
      )
    }

    return true
  })

  // ‚úÖ ËôïÁêÜË®ÇÂñÆÁãÄÊÖãÊõ¥Êñ∞ - Á¥îË≥áÊñôÂ∫´Ê®°Âºè
  const handleOrderStatusUpdate = async (orderId, newStatus, cancelledBy, reason) => {
    try {
      console.log("üîÑ Dashboard: ËôïÁêÜË®ÇÂñÆÁãÄÊÖãÊõ¥Êñ∞:", { orderId, newStatus, cancelledBy, reason })
      
      // ‚úÖ Ë™øÁî® API Êõ¥Êñ∞Ë≥áÊñôÂ∫´
      const success = await syncOrderStatus(orderId, newStatus, cancelledBy, reason, "store")

      if (success) {
        console.log("‚úÖ Dashboard: Ë®ÇÂñÆÁãÄÊÖãÊõ¥Êñ∞ÊàêÂäüÔºåÈáçÊñ∞ËºâÂÖ•Ë®ÇÂñÆÂàóË°®")
        
        // ‚úÖ ÈáçÊñ∞ÂæûË≥áÊñôÂ∫´ËºâÂÖ•Ë®ÇÂñÆÂàóË°®
        if (!account?.storeId) return
        
        const res = await fetch(`/api/orders?storeId=${account.storeId}`, {
          cache: "no-store"
        })
        
        if (res.ok) {
          const json = await res.json()
          if (json.success && json.orders) {
            const storeOrders = json.orders.map((o: any) => ({
              id: o.id,
              userId: o.user_id || o.userId,
              storeId: o.store_id || o.storeId,
              storeName: o.store_name || o.storeName,
              status: o.status,
              createdAt: o.created_at || o.createdAt,
              updatedAt: o.updated_at || o.updatedAt,
              acceptedAt: o.accepted_at || o.acceptedAt,
              preparedAt: o.prepared_at || o.preparedAt,
              completedAt: o.completed_at || o.completedAt,
              total: Number(o.total || 0),
              items: (o.order_items || o.items || []).map((item: any) => ({
                id: item.product_id || item.id,
                name: item.product_name || item.name,
                price: Number(item.price),
                quantity: Number(item.quantity),
              })),
              customerInfo: o.customer_info || o.customerInfo,
              customer: o.customer_info || o.customerInfo,
              note: o.note,
              reason: o.reason,
              cancelledBy: o.cancelled_by,
            }))
            setOrders(storeOrders)
            console.log("‚úÖ Dashboard: Ë®ÇÂñÆÂàóË°®Â∑≤Êõ¥Êñ∞")
          }
        }
      }
    } catch (error) {
      console.error("‚ùå Dashboard: Êõ¥Êñ∞Ë®ÇÂñÆÁãÄÊÖãÈåØË™§:", error)
    }
  }

  // ËôïÁêÜË®ÇÂñÆÊé•Âèó
  const handleAcceptOrder = (orderId) => {
    handleOrderStatusUpdate(orderId, "accepted")
  }

  // ËôïÁêÜË®ÇÂñÆÊ∫ñÂÇôÂÆåÊàê
  const handlePrepareOrder = (orderId) => {
    handleOrderStatusUpdate(orderId, "prepared")
  }

  // ËôïÁêÜË®ÇÂñÆÂÆåÊàê
  const handleCompleteOrder = (orderId) => {
    handleOrderStatusUpdate(orderId, "completed")
  }

  // ËôïÁêÜË®ÇÂñÆÂèñÊ∂à
  const handleCancelOrder = (orderId, reason) => {
    handleOrderStatusUpdate(orderId, "cancelled", "store", reason)
  }

  // ËôïÁêÜË®ÇÂñÆÊãíÁµï
  const handleRejectOrder = (orderId, reason) => {
    handleOrderStatusUpdate(orderId, "rejected", "store", reason)
  }

  // ËôïÁêÜÁáüÊ•≠ÁãÄÊÖãÂàáÊèõ
  const handleToggleOpen = () => {
    setIsOpen(!isOpen)
  }

  // ‚úÖ ËôïÁêÜÂà∑Êñ∞
  const handleRefresh = async () => {
    if (!account) return

    setIsRefreshing(true)

    try {
      // ‚úÖ ‰ªéÊï∞ÊçÆÂ∫ì API Âà∑Êñ∞ËÆ¢Âçï
      const res = await fetch(`/api/orders?storeId=${account.storeId}`, {
        cache: "no-store"
      })
      
      if (res.ok) {
        const json = await res.json()
        if (json.success && json.orders) {
          const storeOrders = json.orders.map((o: any) => ({
            id: o.id,
            userId: o.user_id || o.userId,
            storeId: o.store_id || o.storeId,
            storeName: o.store_name || o.storeName,
            status: o.status,
            createdAt: o.created_at || o.createdAt,
            updatedAt: o.updated_at || o.updatedAt,
            cancelledAt: o.cancelled_at || o.cancelledAt,
            total: Number(o.total || 0),
            items: (o.order_items || o.items || []).map((item: any) => ({
              id: item.product_id || item.id,
              name: item.product_name || item.name,
              price: Number(item.price),
              quantity: Number(item.quantity),
            })),
            customerInfo: o.customer_info || o.customerInfo,
            customer: o.customer_info || o.customerInfo,
            note: o.note,
            reason: o.reason,
            cancelledBy: o.cancelled_by,
          }))
          setOrders(storeOrders)
        }
      }

      // ‚úÖ Âà∑Êñ∞ÂïÜÂìÅÊï∏Êìö
      const productsRes = await fetch(`/api/user/products?storeId=${account.storeId}`)
      if (productsRes.ok) {
        const productsJson = await productsRes.json()
        setProducts(productsJson.products || [])
      }
    } catch (error) {
      console.error("Error refreshing data:", error)
    } finally {
      setTimeout(() => {
        setIsRefreshing(false)
      }, 500)
    }
  }

  if (loading) {
    return <div className="container mx-auto px-4 py-8">ËºâÂÖ•‰∏≠...</div>
  }

  if (!account) {
    return null
  }

  return (
    <div className="container mx-auto px-4 py-4 md:py-8 max-w-7xl">
      <div className="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold">Â∫óÂÆ∂ÂÑÄË°®Êùø</h1>
          <p className="text-muted-foreground">
            {storeInfo?.name || account?.name}
            {storeInfo && (
              <span className="ml-2 text-sm text-gray-500">
                (Â∫óÂÆ∂‰ª£Ëôü: {storeInfo.storeCode})
              </span>
            )}
          </p>
        </div>
        <div className="flex items-center mt-4 md:mt-0">
          <div className="flex items-center space-x-2">
            <Switch id="store-open" checked={isOpen} onCheckedChange={handleToggleOpen} />
            <Label htmlFor="store-open" className="font-medium">
              {isOpen ? "ÁáüÊ•≠‰∏≠" : "‰ºëÊÅØ‰∏≠"}
            </Label>
          </div>
        </div>
      </div>

      {/* Áµ±Ë®àÂç°Áâá - ÊîπÈÄ≤ÁöÑÈüøÊáâÂºèË®≠Ë®à */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
        <Card className="bg-amber-50 border-amber-200">
          <CardContent className="p-4 md:p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-amber-800 font-medium text-sm md:text-base">ÂïÜÂìÅÊï∏Èáè</p>
                <h3 className="text-2xl md:text-3xl font-bold text-amber-900 mt-1">{products.length}</h3>
                <p className="text-amber-700 text-xs md:text-sm mt-1">ÊâÄÊúâÂïÜÂìÅÁ∏ΩÊï∏</p>
              </div>
              <Package className="h-8 w-8 md:h-10 md:w-10 text-amber-500" />
            </div>
          </CardContent>
        </Card>

        <Card className="bg-blue-50 border-blue-200">
          <CardContent className="p-4 md:p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-blue-800 font-medium text-sm md:text-base">ÂæÖËôïÁêÜË®ÇÂñÆ</p>
                <h3 className="text-2xl md:text-3xl font-bold text-blue-900 mt-1">{ordersByStatus.pending.length}</h3>
                <p className="text-blue-700 text-xs md:text-sm mt-1">ÈúÄË¶ÅÁ¢∫Ë™çÁöÑË®ÇÂñÆ</p>
              </div>
              <Clock className="h-8 w-8 md:h-10 md:w-10 text-blue-500" />
            </div>
          </CardContent>
        </Card>

        <Card className="bg-green-50 border-green-200">
          <CardContent className="p-4 md:p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-green-800 font-medium text-sm md:text-base">Â∑≤Ê∫ñÂÇôË®ÇÂñÆ</p>
                <h3 className="text-2xl md:text-3xl font-bold text-green-900 mt-1">{ordersByStatus.prepared.length}</h3>
                <p className="text-green-700 text-xs md:text-sm mt-1">Á≠âÂæÖÈ°ßÂÆ¢ÂèñÈ§ê</p>
              </div>
              <CheckCircle className="h-8 w-8 md:h-10 md:w-10 text-green-500" />
            </div>
          </CardContent>
        </Card>

        <Card className="bg-purple-50 border-purple-200">
          <CardContent className="p-4 md:p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-purple-800 font-medium text-sm md:text-base">Á∏ΩË®ÇÂñÆÊï∏</p>
                <h3 className="text-2xl md:text-3xl font-bold text-purple-900 mt-1">{orders.length}</h3>
                <p className="text-purple-700 text-xs md:text-sm mt-1">ÊâÄÊúâË®ÇÂñÆÁ∏ΩÊï∏</p>
              </div>
              <ClipboardList className="h-8 w-8 md:h-10 md:w-10 text-purple-500" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Ë®ÇÂñÆÁÆ°ÁêÜ - ÊîπÈÄ≤ÁöÑÈüøÊáâÂºèË®≠Ë®à */}
      <Card className="mb-8 border-gray-200 shadow-sm">
        <CardHeader className="pb-2 pt-4 px-4 md:px-6">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <CardTitle className="text-lg md:text-xl">Ë®ÇÂñÆÁÆ°ÁêÜ</CardTitle>
              <CardDescription className="text-xs md:text-sm mt-1">
                ÁÆ°ÁêÜÊÇ®ÁöÑË®ÇÂñÆÔºåÊé•ÂèóÊàñÊãíÁµïÊñ∞Ë®ÇÂñÆÔºåËøΩËπ§Ë®ÇÂñÆÁãÄÊÖã„ÄÇ
              </CardDescription>
            </div>
            <div className="flex items-center gap-2">
              <div className="relative flex-1 md:w-64">
                <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="ÊêúÂ∞ãË®ÇÂñÆ..."
                  className="pl-9 h-9 text-sm"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>
              <Button variant="outline" size="sm" onClick={handleRefresh} disabled={isRefreshing} className="h-9 px-3">
                <RefreshCcw className={`h-4 w-4 mr-1.5 ${isRefreshing ? "animate-spin" : ""}`} />
                Âà∑Êñ∞
              </Button>
            </div>
          </div>
        </CardHeader>
        <CardContent className="p-0 pt-2">
          {/* ÊîπÈÄ≤ÁöÑÊ®ôÁ±§Â∞éËà™ */}
          <div className="px-4 md:px-6 overflow-x-auto">
            <Tabs defaultValue="all" value={activeTab} onValueChange={setActiveTab} className="w-full">
              <TabsList className="grid grid-cols-3 md:grid-cols-6 mb-4 h-auto p-1">
                <TabsTrigger value="all" className="py-1.5 text-xs md:text-sm">
                  ÂÖ®ÈÉ®
                </TabsTrigger>

                {/* ÂæÖËôïÁêÜÊ®ôÁ±§ - Âè™ÊúâÁï∂ÊúâË®ÇÂñÆÊôÇÊâçÈ°ØÁ§∫Ê©òËâ≤Ê≥°Ê≥° */}
                <TabsTrigger value="pending" className="relative py-1.5 text-xs md:text-sm">
                  ÂæÖËôïÁêÜ
                  {ordersByStatus.pending.length > 0 && (
                    <Badge variant="destructive" className="absolute -top-1 -right-1 px-1.5 py-0 min-w-5 h-5 text-xs">
                      {ordersByStatus.pending.length}
                    </Badge>
                  )}
                </TabsTrigger>

                {/* Ê∫ñÂÇô‰∏≠Ê®ôÁ±§ - Âè™ÊúâÁï∂ÊúâË®ÇÂñÆÊôÇÊâçÈ°ØÁ§∫Ê©òËâ≤Ê≥°Ê≥° */}
                <TabsTrigger value="accepted" className="relative py-1.5 text-xs md:text-sm">
                  Ê∫ñÂÇô‰∏≠
                  {ordersByStatus.accepted.length > 0 && (
                    <Badge variant="destructive" className="absolute -top-1 -right-1 px-1.5 py-0 min-w-5 h-5 text-xs">
                      {ordersByStatus.accepted.length}
                    </Badge>
                  )}
                </TabsTrigger>

                {/* Â∑≤Ê∫ñÂÇôÊ®ôÁ±§ - Âè™ÊúâÁï∂ÊúâË®ÇÂñÆÊôÇÊâçÈ°ØÁ§∫Ê©òËâ≤Ê≥°Ê≥° */}
                <TabsTrigger value="prepared" className="relative py-1.5 text-xs md:text-sm">
                  Â∑≤Ê∫ñÂÇô
                  {ordersByStatus.prepared.length > 0 && (
                    <Badge variant="destructive" className="absolute -top-1 -right-1 px-1.5 py-0 min-w-5 h-5 text-xs">
                      {ordersByStatus.prepared.length}
                    </Badge>
                  )}
                </TabsTrigger>

                {/* Â∑≤ÂÆåÊàêÊ®ôÁ±§ - ‰∏çÈ°ØÁ§∫Ê©òËâ≤Ê≥°Ê≥° */}
                <TabsTrigger value="completed" className="py-1.5 text-xs md:text-sm">
                  Â∑≤ÂÆåÊàê
                </TabsTrigger>

                {/* Â∑≤ÂèñÊ∂àÊ®ôÁ±§ - ‰∏çÈ°ØÁ§∫Ê©òËâ≤Ê≥°Ê≥° */}
                <TabsTrigger value="cancelled" className="py-1.5 text-xs md:text-sm">
                  Â∑≤ÂèñÊ∂à
                </TabsTrigger>
              </TabsList>

              <TabsContent value={activeTab} className="mt-0">
                <div className="space-y-3 md:space-y-4 px-0 pb-4">
                  {filteredOrders.length > 0 ? (
                    filteredOrders.map((order) => (
                      <OrderCard
                        key={order.id}
                        order={order}
                        onAccept={() => handleAcceptOrder(order.id)}
                        onPrepare={() => handlePrepareOrder(order.id)}
                        onComplete={() => handleCompleteOrder(order.id)}
                        onCancel={(reason) => handleCancelOrder(order.id, reason)}
                        onReject={(reason) => handleRejectOrder(order.id, reason)}
                      />
                    ))
                  ) : (
                    <div className="text-center py-8 md:py-12 bg-gray-50 rounded-lg mx-4">
                      <AlertCircle className="h-10 w-10 md:h-12 md:w-12 mx-auto mb-3 md:mb-4 text-gray-400" />
                      <h2 className="text-lg md:text-xl font-medium mb-1 md:mb-2">Ê≤íÊúâË®ÇÂñÆ</h2>
                      <p className="text-gray-500 text-sm md:text-base mb-4">
                        {searchQuery ? "Ê≤íÊúâÁ¨¶ÂêàÊêúÂ∞ãÊ¢ù‰ª∂ÁöÑË®ÇÂñÆ" : "ÁõÆÂâçÊ≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®ÇÂñÆ"}
                      </p>
                    </div>
                  )}
                </div>
              </TabsContent>
            </Tabs>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
